<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Kru Pai Classroom ¬∑ Hunt for 5 ¬∑ Falling Grid Version</title>
<style>
  :root{
    --bg:#fdfbff;
    --panel:#ffffff;
    --panel-soft:#fff6ff;
    --ink:#342049;
    --muted:#7b6c8c;
    --accent:#ff6ad5;
    --accent-soft:#ff9ff3;
    --ok:#00b894;
    --bad:#e84365;
    --shadow:0 12px 30px rgba(0,0,0,.10);
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  html,body{
    margin:0;
    height:100%;
    font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:var(--ink);
  }

  header{
    position:sticky;
    top:0;
    z-index:5;
    background:linear-gradient(120deg,#ffe7f8,#fff7d9);
    border-bottom:2px solid rgba(255,150,210,.7);
    padding:10px 14px;
    box-shadow:0 6px 20px rgba(0,0,0,.06);
  }
  .brand{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    font-weight:900;
    letter-spacing:.4px;
    font-size:clamp(17px,5vw,21px);
  }
  .brand span:first-child{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .brand-emoji{font-size:20px;}
  .badge{
    font-size:11px;
    font-weight:900;
    padding:4px 10px;
    border-radius:999px;
    background:#ffffff;
    color:#ff3f9a;
    border:1px solid rgba(255,150,210,.7);
    box-shadow:0 0 0 2px rgba(255,255,255,.7);
  }

  main{
    max-width:1200px;
    margin:0 auto;
    padding:16px;
  }
  .card{
    background:var(--panel);
    border-radius:22px;
    border:1.5px solid #f4e6ff;
    box-shadow:var(--shadow);
    padding:18px;
    margin:12px 0;
    position:relative;
    overflow:hidden;
  }

  .card-dark{
    background:#05040a;
    border-color:#141326;
  }
  .card-dark .title{
    color:#f9f5ff;
  }
  .card-dark .sub{
    color:#dcd5ff;
  }
  .card::before{
    content:"";
    position:absolute;
    inset:-40px;
    background:
      radial-gradient(circle at 0% 0%, rgba(255,214,255,.55), transparent 55%),
      radial-gradient(circle at 100% 120%, rgba(196,224,255,.55), transparent 55%);
    opacity:.45;
    pointer-events:none;
    z-index:-1;
  }

  .title{
    font-size:clamp(22px,6vw,30px);
    font-weight:900;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .title-emoji{font-size:26px;}
  .sub{color:var(--muted);font-size:16px;}

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    margin-top:10px;
  }

  .input{
    flex:1;
    min-width:180px;
    border-radius:14px;
    border:1.5px solid #e3d7ff;
    padding:10px 12px;
    background:#ffffff;
    color:var(--ink);
    font-weight:800;
    outline:none;
  }
  .input::placeholder{color:#b9a9d4;}
  .input:focus{
    box-shadow:0 0 0 3px rgba(255,180,255,.7);
    border-color:var(--accent);
  }

  .btn{
    border:0;
    border-radius:16px;
    padding:12px 16px;
    font-weight:900;
    cursor:pointer;
    min-width:160px;
    font-size:15px;
    box-shadow:0 10px 24px rgba(0,0,0,.12);
    transition:transform .08s ease, box-shadow .12s ease, filter .12s ease;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 6px 16px rgba(0,0,0,.14);}
  .btn.primary{
    background:linear-gradient(120deg,#ff6ad5,#ffb960);
    color:#3b1630;
  }
  .btn.alt{
    background:#ffffff;
    border:1.5px solid #e0d1ff;
    color:var(--ink);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:#ffffff;
    border:1.5px solid #eedfff;
    font-size:12px;
    font-weight:800;
    color:var(--muted);
  }
  .pill b{color:#ff5ba9;}
  .pill-emoji{font-size:14px;}

  .game-area{
    margin-top:14px;
    border-radius:20px;
    border:1.5px solid #f4e4ff;
    background:#fffdfd;
    box-shadow:0 14px 30px rgba(0,0,0,.06);
    padding:10px;
  }

  .mission{
    font-size:14px;
    font-weight:800;
    color:#ff5ba9;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .mission .mission-emoji{font-size:18px;}

  .playfield{
    position:relative;
    height:clamp(380px,60vh,520px);
    max-height:65vh;
    overflow:hidden;
    border-radius:18px;
    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏ô‡∏î‡∏≥‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ + ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏¥‡∏î‡πÄ‡∏ö‡∏≤ ‡πÜ */
    background:
      radial-gradient(circle at 0% 0%, rgba(120,170,255,.45), transparent 55%),
      radial-gradient(circle at 100% 100%, rgba(255,200,120,.28), transparent 60%),
      repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0, rgba(255,255,255,.08) 1px, transparent 1px, transparent 26px),
      repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0, rgba(255,255,255,.06) 1px, transparent 1px, transparent 26px),
      #050814;
  }

  .top-hint{
    position:absolute;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,.96);
    border-radius:999px;
    padding:4px 12px;
    font-size:11px;
    border:1px solid #ffd8f4;
    color:var(--muted);
    pointer-events:none;
    z-index:1;
    display:flex;
    align-items:center;
    gap:4px;
  }
  .top-hint span{font-size:14px;}

  .expr{
    position:absolute;
    top:-40px;
    padding:10px 22px;
    border-radius:999px;
    font-size:clamp(20px,5vw,30px);
    font-weight:900;
    background:#e3f3ff;
    color:var(--ink);
    border:2.5px solid #82c3ff;
    cursor:pointer;
    white-space:nowrap;
    box-shadow:0 8px 18px rgba(0,0,0,.10);
    animation:fall linear forwards;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:2;
  }

  @keyframes fall{
    from{transform:translateY(0);}
    to{transform:translateY(120vh);}
  }

  .expr.hit{
    background:linear-gradient(120deg,#fff8ff,#ffe9b4);
    color:#3b132b;
    border-color:#ffd86b;
    box-shadow:0 0 18px rgba(255,210,130,.7);
    animation:hitPop .45s ease-out forwards;
  }
  @keyframes hitPop{
    0%{transform:scale(1) translateY(0);}
    50%{transform:scale(1.15) translateY(-14px);}
    100%{transform:scale(.9) translateY(22px);opacity:0;}
  }

  .expr.miss{
    background:#ffe9f1;
    border-color:#ffb0c0;
    color:#c02040;
    animation:missShake .4s ease-out forwards;
  }
  @keyframes missShake{
    0%{transform:translateX(0);}
    25%{transform:translateX(-6px);}
    50%{transform:translateX(6px);}
    75%{transform:translateX(-3px);}
    100%{transform:translateX(0);opacity:.7;}
  }

  .glitter{
    position:fixed;
    pointer-events:none;
    font-size:22px;
    animation:glitterPop 900ms ease-out forwards;
    filter:drop-shadow(0 0 5px rgba(255,210,255,.9));
  }
  @keyframes glitterPop{
    0%{transform:translateY(0) scale(.9);opacity:1;}
    100%{transform:translateY(-50px) scale(1.2);opacity:0;}
  }

  .footer-nav{
    margin-top:14px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .footer-nav .btn{flex:1;}

  .center{text-align:center;}
  .big{
    font-size:clamp(40px,12vw,72px);
    font-weight:900;
    color:#ffeb99;
    text-shadow:0 0 18px rgba(255,230,150,.9);
  }
  .big-emoji{
    font-size:34px;
    display:block;
    margin-bottom:4px;
  }
  #finalScore{
    background:linear-gradient(90deg,#ffdf70,#ff9ff3);
    -webkit-background-clip:text;
    color:transparent;
    text-shadow:0 0 18px rgba(255,200,160,.9);
  }
#finalScore{
    display:block;
    margin-top:4px;
    letter-spacing:.06em;
  }
  .hidden{display:none!important;}

  @media (min-width:1200px){
    body{font-size:20px;}
    .playfield{height:430px;}
    .expr{
      font-size:32px;
      padding:12px 26px;
    }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <span>
      <span class="brand-emoji">‚ûó</span>
      Kru Pai Classroom ¬∑ Hunt for 5
    </span>
    <span class="badge">Math Hunt for 5 ¬∑ Falling Grid üéØ</span>
  </div>
</header>

<main>
    <!-- Intro title page -->
  <section id="intro" class="card card-dark center">
    <div class="title">
      <span class="title-emoji">‚ö°</span>
      Fast Math Hunter ¬∑ <span style="white-space:nowrap;">HUNT FOR 5</span>
    </div>
    <p class="sub">
      Quick-fire number sense game for kids and classrooms. üí°<br>
      Train students to spot which expressions really equal <b>5</b> ‚Äî under time pressure!<br><br>
      Perfect for<br>
      ‚Ä¢ warm-up brain breaks üß†<br>
      ‚Ä¢ math centres & fast-finishers üéØ<br>
      ‚Ä¢ TV / projector challenges in class üì∫
    </p>
    <div class="row" style="margin-top:16px;justify-content:center;">
      <button id="btnGoStart" class="btn primary">Next ¬∑ How to Play ‚ñ∂</button>
    </div>
  </section>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° -->
  <section id="start" class="card card-dark hidden">
    <div class="title">
      <span class="title-emoji">üé≤</span>
      Hunt for 5 ¬∑ Speed Mission
    </div>
    <p class="sub">
      Fast mental math game: <b>Tap only the expressions that equal 5</b> üí•<br><br>
      How to play:<br>
      ‚Ä¢ Correct examples: <b>10 ‚àí 5, 2 + 3, 25 √∑ 5, 1 √ó 5</b><br>
      ‚Ä¢ Not 5: <b>2 + 2, 9 ‚àí 2, 15 √∑ 3, 3 + 6</b><br><br>
      Scoring:<br>
      ‚Ä¢ Tap correct (answer = 5) ‚ûú <b>+1 point</b><br>
      ‚Ä¢ Tap wrong ‚ûú <b>‚àí1 point</b><br>
      ‚Ä¢ Let a 5 fall without tapping ‚ûú it counts as a miss üòÜ<br><br>
      You have <b>180 seconds</b>. Boxes keep falling on the grid ‚Äì try to catch all <b>30</b> ‚Äú5‚Äù expressions! üíó‚ûï
    </p>
    <div class="row">
      <input id="playerName" class="input" placeholder="Type player name, e.g. Beam, New, Mint üßë‚Äçüéì">
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnStart" class="btn primary">Start the Hunt! ‚ñ∂</button>
    </div>
  </section>


<!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏° -->
  <section id="game" class="card hidden">
    <div class="row">
      <span class="pill"><span class="pill-emoji">üëß</span>Player: <b id="displayName">-</b></span>
      <span class="pill"><span class="pill-emoji">‚è±Ô∏è</span>Time: <b id="time">180</b>s</span>
      <span class="pill"><span class="pill-emoji">‚≠ê</span>Score: <b id="score">0</b></span>
      <span class="pill"><span class="pill-emoji">‚úÖ</span>Correct hits: <b id="hits">0</b></span>
      <span class="pill"><span class="pill-emoji">‚ùå</span>Misses: <b id="misses">0</b></span>
    </div>

    <div class="game-area">
      <div class="mission">
        <span class="mission-emoji">üßÆ</span>
        Mission: Tap only expressions whose answer is <b>5</b>. Try to find all <b>30</b> within 180 seconds!
      </div>
      <div class="playfield" id="playfield">
        <div class="top-hint">
          <span>üëÜ</span>
          Think before you tap: choose only the expressions that equal 5.
        </div>
      </div>
    </div>

    <div class="footer-nav">
      <button id="btnGiveUp" class="btn alt">End Game & Show Summary üìù</button>
    </div>
  </section>


<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ -->
  <section id="summary" class="card card-dark hidden center">
    <div class="title">
      <span class="title-emoji">üèÅ</span>
      Hunt for 5 ¬∑ Game Summary
    </div>
    <div class="big">
      <span class="big-emoji" id="emojiScore">üéâ</span>
      <span id="finalScore">0 points</span>
    </div>
    <p class="sub" id="detailScore"></p>
    <p class="sub" id="commentText"></p>
    <div class="footer-nav">
      <button id="btnReplay" class="btn primary">Play Again üîÅ</button>
      <button id="btnLevel2" class="btn primary" style="display:none;">Level 2 ¬∑ Hard Mode üî•</button>
      <button id="btnBackHome" class="btn alt">Back to Start üè°</button>
    </div>
  </section>
</main>

<script>
/* üîä Simple SFX */
let audioCtx;
function beep(freq=760, dur=0.08, type="sine", gain=0.04){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{o.stop(); o.disconnect(); g.disconnect();}, dur*1000);
  }catch(e){}
}
function okSound(){ beep(1040,0.07,"triangle",0.055); setTimeout(()=>beep(1500,0.09,"triangle",0.05),90); }
function badSound(){ beep(220,0.16,"sawtooth",0.07); }

/* üéØ ‡∏ä‡∏∏‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏•‡∏∞ ‡πÜ (‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ) */
const EXPRESSIONS_L1 = [
  // answer = 5
  { text:"10 ‚àí 5", value:5 },
  { text:"2 + 3", value:5 },
  { text:"3 + 2", value:5 },
  { text:"4 + 1", value:5 },
  { text:"1 + 4", value:5 },
  { text:"25 √∑ 5", value:5 },
  { text:"20 √∑ 4", value:5 },
  { text:"15 √∑ 3", value:5 },
  { text:"35 √∑ 7", value:5 },
  { text:"40 √∑ 8", value:5 },
  { text:"45 √∑ 9", value:5 },
  { text:"50 √∑ 10", value:5 },
  { text:"60 √∑ 12", value:5 },
  { text:"9 ‚àí 4", value:5 },
  { text:"11 ‚àí 6", value:5 },
  { text:"13 ‚àí 8", value:5 },
  { text:"15 ‚àí 10", value:5 },
  { text:"18 ‚àí 13", value:5 },
  { text:"22 ‚àí 17", value:5 },
  { text:"27 ‚àí 22", value:5 },
  { text:"32 ‚àí 27", value:5 },
  { text:"100 √∑ 20", value:5 },
  { text:"70 √∑ 14", value:5 },
  { text:"55 √∑ 11", value:5 },
  { text:"5 √ó 1", value:5 },
  { text:"1 √ó 5", value:5 },
  { text:"5 + 0", value:5 },
  { text:"0 + 5", value:5 },
  { text:"6 ‚àí 1", value:5 },
  { text:"8 ‚àí 3", value:5 },

  // not 5 (decoys)
  { text:"2 + 2", value:4 },
  { text:"3 + 4", value:7 },
  { text:"9 ‚àí 2", value:7 },
  { text:"18 √∑ 3", value:6 },
  { text:"12 √∑ 4", value:3 },
  { text:"3 + 3", value:6 },
  { text:"7 ‚àí 1", value:6 },
  { text:"21 √∑ 7", value:3 },
  { text:"16 ‚àí 9", value:7 },
  { text:"8 + 8", value:16 },
  { text:"4 √ó 4", value:16 },
  { text:"6 √ó 2", value:12 },
  { text:"9 + 1", value:10 },
  { text:"10 ‚àí 2", value:8 },
  { text:"14 ‚àí 4", value:10 },
  { text:"3 √ó 3", value:9 },
  { text:"12 √∑ 2", value:6 },
  { text:"5 + 7", value:12 },
  { text:"20 √∑ 2", value:10 },
  { text:"30 √∑ 3", value:10 },
  { text:"8 ‚àí 1", value:7 },
  { text:"11 ‚àí 4", value:7 },
  { text:"9 ‚àí 1", value:8 },
  { text:"25 √∑ 4", value:6.25 },
  { text:"18 ‚àí 12", value:6 },
  { text:"5 √ó 2", value:10 },
  { text:"4 + 4", value:8 },
  { text:"14 √∑ 2", value:7 },
  { text:"24 √∑ 8", value:3 }
];

const EXPRESSIONS_L2 = [
  // Level 2: three-term expressions, answer = 5
  { text:"2 + 8 ‚àí 5", value:5 },
  { text:"5 √ó 4 ‚àí 15", value:5 },
  { text:"3 √ó 3 ‚àí 4", value:5 },
  { text:"12 ‚àí 7 + 0", value:5 },
  { text:"9 + 1 ‚àí 5", value:5 },
  { text:"2 √ó 5 ‚àí 5", value:5 },
  { text:"1 + 9 ‚àí 5", value:5 },
  { text:"7 + 3 ‚àí 5", value:5 },
  { text:"6 + 4 ‚àí 5", value:5 },
  { text:"4 √ó 3 ‚àí 7", value:5 },
  { text:"16 ‚àí 6 ‚àí 5", value:5 },
  { text:"20 ‚àí 3 √ó 5", value:5 },
  { text:"18 ‚àí 8 ‚àí 5", value:5 },
  { text:"6 √ó 2 ‚àí 7", value:5 },
  { text:"15 ‚àí 5 ‚àí 5", value:5 },
  { text:"11 ‚àí 1 ‚àí 5", value:5 },
  { text:"14 ‚àí 4 ‚àí 5", value:5 },
  { text:"21 ‚àí 11 ‚àí 5", value:5 },
  { text:"3 + 7 ‚àí 5", value:5 },
  { text:"13 ‚àí 3 ‚àí 5", value:5 },
  { text:"19 ‚àí 9 ‚àí 5", value:5 },
  { text:"10 + 5 ‚àí 10", value:5 },
  { text:"8 + 7 ‚àí 10", value:5 },
  { text:"4 √ó 5 ‚àí 15", value:5 },
  { text:"5 √ó 3 ‚àí 10", value:5 },
  { text:"3 √ó 4 ‚àí 7", value:5 },
  { text:"2 √ó 6 ‚àí 7", value:5 },
  { text:"7 √ó 2 ‚àí 9", value:5 },
  { text:"9 + 9 ‚àí 13", value:5 },

  // not 5 (decoys)
  { text:"2 + 8 ‚àí 3", value:7 },
  { text:"5 √ó 4 ‚àí 10", value:10 },
  { text:"3 √ó 3 ‚àí 2", value:7 },
  { text:"12 ‚àí 4 + 0", value:8 },
  { text:"9 + 2 ‚àí 5", value:6 },
  { text:"2 √ó 5 ‚àí 3", value:7 },
  { text:"1 + 9 ‚àí 3", value:7 },
  { text:"7 + 3 ‚àí 2", value:8 },
  { text:"6 + 4 ‚àí 4", value:6 },
  { text:"4 √ó 3 ‚àí 5", value:7 },
  { text:"16 ‚àí 4 ‚àí 5", value:7 },
  { text:"18 ‚àí 6 ‚àí 5", value:7 },
  { text:"6 √ó 2 ‚àí 5", value:7 },
  { text:"15 ‚àí 3 ‚àí 5", value:7 },
  { text:"11 ‚àí 2 ‚àí 5", value:4 },
  { text:"14 ‚àí 3 ‚àí 5", value:6 },
  { text:"21 ‚àí 9 ‚àí 5", value:7 },
  { text:"3 + 7 ‚àí 3", value:7 },
  { text:"13 ‚àí 2 ‚àí 5", value:6 },
  { text:"19 ‚àí 8 ‚àí 5", value:6 },
  { text:"10 + 5 ‚àí 9", value:6 },
  { text:"8 + 7 ‚àí 8", value:7 },
  { text:"4 √ó 5 ‚àí 10", value:10 },
  { text:"5 √ó 3 ‚àí 6", value:9 },
  { text:"3 √ó 4 ‚àí 4", value:8 },
  { text:"2 √ó 6 ‚àí 5", value:7 },
  { text:"7 √ó 2 ‚àí 5", value:9 },
  { text:"9 + 9 ‚àí 10", value:8 }
];
/* ‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
const GAME_TIME = 180;       // ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const SPAWN_INTERVAL = 1100; // ‡∏≠‡∏≠‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Å‡∏µ‡πà ms (‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏ö‡∏ö‡∏Å‡∏î‡∏°‡∏±‡∏ô ‡πÜ)
const MIN_DUR = 8;          // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ä‡πâ‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå)
const EXTRA_DUR = 3.5;      // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°

const TARGET_HITS = 30;      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö = 5 ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
const PASS_RATIO = 0.8;      // ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 80% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Level 2

let currentLevel = 1;        // 1 = ‡∏á‡πà‡∏≤‡∏¢, 2 = ‡∏¢‡∏≤‡∏Å
let EXPRESSIONS = EXPRESSIONS_L1; // ‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏° level ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô

let timeLeft = GAME_TIME;
let timerId = null;
let spawnId = null;
let running = false;
let score = 0;
let hits = 0;
let misses = 0;
let usedTime = 0;

const $ = id => document.getElementById(id);
const E = {
  intro: $("intro"),
  start: $("start"),
  game: $("game"),
  summary: $("summary"),
  playfield: $("playfield"),
  nameInput: $("playerName"),
  displayName: $("displayName"),
  btnGoStart: $("btnGoStart"),
  btnStart: $("btnStart"),
  btnGiveUp: $("btnGiveUp"),
  btnReplay: $("btnReplay"),
  btnLevel2: $("btnLevel2"),
  btnBackHome: $("btnBackHome"),
  time: $("time"),
  score: $("score"),
  hits: $("hits"),
  misses: $("misses"),
  finalScore: $("finalScore"),
  emojiScore: $("emojiScore"),
  detailScore: $("detailScore"),
  commentText: $("commentText")
};

function formatScore(n){
  return (n % 1 === 0) ? n.toString() : n.toFixed(1);
}

function glitter(x,y,good=true){
  const g = document.createElement("div");
  g.className = "glitter";
  g.textContent = good ? "‚ú®" : "üí•";
  g.style.left = (x-10) + "px";
  g.style.top = (y-10) + "px";
  document.body.appendChild(g);
  setTimeout(()=>g.remove(), 900);
}

function megaConfetti(){
  const w = window.innerWidth;
  const h = window.innerHeight;
  for(let i=0;i<40;i++){
    const x = Math.random()*w;
    const y = Math.random()*h*0.7;
    glitter(x,y,true);
  }
}

/* ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ô‡∏≤‡∏° + ‡πÉ‡∏™‡πà Hint */
function clearField(){
  while(E.playfield.firstChild){
    E.playfield.removeChild(E.playfield.firstChild);
  }
  const hint = document.createElement("div");
  hint.className = "top-hint";
  hint.innerHTML = "<span>üëÜ</span>Tip: Tap only when you are sure the expression equals 5.";
  E.playfield.appendChild(hint);
}

/* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° */
function startGame(){
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  EXPRESSIONS = (currentLevel === 1 ? EXPRESSIONS_L1 : EXPRESSIONS_L2);

  const name = (E.nameInput.value || "Player").trim().slice(0,24);
  E.displayName.textContent = name || "Player";

  score = 0; hits = 0; misses = 0;
  timeLeft = GAME_TIME;
  E.time.textContent = timeLeft;
  E.score.textContent = formatScore(score);
  E.hits.textContent = hits;
  E.misses.textContent = misses;

  clearField();

  E.start.classList.add("hidden");
  E.summary.classList.add("hidden");
  E.game.classList.remove("hidden");

  running = true;
  startTimer();
  startSpawning();
}


/* ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ */
/* ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ */
function startTimer(){
  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--;
    if(timeLeft < 0) timeLeft = 0;
    E.time.textContent = timeLeft;
    if(timeLeft <= 0){
      endGame();
    }
  },1000);
}

/* ‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏£‡πà‡∏ß‡∏á */
function startSpawning(){
  if(spawnId) clearInterval(spawnId);
  spawnId = setInterval(()=>{
    if(!running) return;
    spawnExpression();
  }, SPAWN_INTERVAL);
}

function spawnExpression(){
  const w = EXPRESSIONS[Math.floor(Math.random()*EXPRESSIONS.length)];
  const exprEl = document.createElement("div");
  exprEl.className = "expr";
  exprEl.textContent = w.text;
  exprEl.dataset.value = w.value;

  const pfRect = E.playfield.getBoundingClientRect();
  const maxWidth = pfRect.width || window.innerWidth;
  const left = 12 + Math.random() * (maxWidth - 160);
  exprEl.style.left = left + "px";

  const duration = MIN_DUR + Math.random()*EXTRA_DUR;
  exprEl.style.animationDuration = duration + "s";

  exprEl.addEventListener("animationend", ()=>{
    if(!running){
      exprEl.remove();
      return;
    }
    const v = Number(exprEl.dataset.value);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö = 5 ‡πÅ‡∏ï‡πà‡πÄ‡∏î‡πá‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î -> ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏•‡∏≤‡∏î
    if(v === 5 && !exprEl.classList.contains("hit")){
      misses += 1;
      E.misses.textContent = misses;
    }
    exprEl.remove();
  });

  E.playfield.appendChild(exprEl);
}

/* ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå */
E.playfield.addEventListener("click", ev=>{
  if(!running) return;
  const exprEl = ev.target.closest(".expr");
  if(!exprEl) return;
  if(exprEl.classList.contains("hit") || exprEl.classList.contains("miss")) return;

  const v = Number(exprEl.dataset.value);
  if(v === 5){
    // ‡∏Å‡∏î‡∏ñ‡∏π‡∏Å
    score += 1;
    hits += 1;
    E.score.textContent = formatScore(score);
    E.hits.textContent = hits;
    exprEl.classList.add("hit");
    okSound();
    glitter(ev.clientX, ev.clientY, true);
    setTimeout(()=>exprEl.remove(), 450);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if(hits >= TARGET_HITS){
      endGame();
      return;
    }
  }else{
    // ‡∏Å‡∏î‡∏ú‡∏¥‡∏î
    score -= 1;
    misses += 1;
    E.score.textContent = formatScore(score);
    E.misses.textContent = misses;
    exprEl.classList.add("miss");
    badSound();
    glitter(ev.clientX, ev.clientY, false);
    setTimeout(()=>exprEl.remove(), 420);
  }
});

/* ‡∏à‡∏ö‡πÄ‡∏Å‡∏° */
function endGame(){
  if(!running) return;
  running = false;
  if(timerId) clearInterval(timerId);
  if(spawnId) clearInterval(spawnId);
  timerId = null;
  spawnId = null;

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (GAME_TIME - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
  usedTime = GAME_TIME - timeLeft;
  if(usedTime < 0) usedTime = 0;

  const items = E.playfield.querySelectorAll(".expr");
  items.forEach(el=>{
    el.style.pointerEvents = "none";
    el.style.opacity = "0.2";
  });

  setTimeout(showSummary, 600);
}

function showSummary(){
  E.game.classList.add("hidden");
  E.summary.classList.remove("hidden");

  E.finalScore.textContent = formatScore(score) + " points";

  // Show 4 key stats: correct / misses / score / time used
  E.detailScore.innerHTML =
    `Correct hits (answer = 5): <b>${hits}</b> / target <b>${TARGET_HITS}</b><br>` +
    `Misses or missed 5s: <b>${misses}</b><br>` +
    `Final score: <b>${formatScore(score)}</b> points<br>` +
    `Time used: <b>${usedTime}</b> seconds (of ${GAME_TIME} seconds)`;

  let comment = "";
  let emoji = "üéâ";

  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à/‡∏¢‡∏® ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô
  if(hits >= TARGET_HITS && score >= TARGET_HITS - 2){
    comment = "Legendary! Perfect or near-perfect hunt. This player is a true number ninja. üèÜ";
    emoji = "üèÜ";
  }else if(hits >= Math.round(TARGET_HITS*0.85)){
    comment = "Amazing! Lightning-fast number sense. Try again and go for a perfect run. ‚ú®";
    emoji = "‚≠ê";
  }else if(hits >= Math.round(TARGET_HITS*0.7)){
    comment = "Great job! You can spot 5 very quickly. Play again and try to beat your best time. üí™";
    emoji = "üí™";
  }else if(score < 0){
    comment = "Nice speed, but a bit too many guesses. Slow down a little and check each expression before you tap. üå±";
    emoji = "üå±";
  }else{
    comment = "Good warm-up round! Review how each expression becomes 5, then play again to see big improvement. üíñ";
    emoji = "üòä";
  }

  E.commentText.textContent = comment;
  E.emojiScore.textContent = emoji;

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Level 2: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ Level 1 ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 80% ‡∏Ç‡∏≠‡∏á TARGET_HITS
  const needed = Math.round(TARGET_HITS * PASS_RATIO);
  if(currentLevel === 1 && hits >= needed){
    E.btnLevel2.style.display = "inline-block";
    // celebrate with big confetti when player unlocks Level 2
    megaConfetti();
  }else{
    E.btnLevel2.style.display = "none";
  }
}


/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
E.btnGoStart.addEventListener("click", ()=>{
  // from title page to how-to-play page
  E.intro.classList.add("hidden");
  E.start.classList.remove("hidden");
});

E.btnStart.addEventListener("click", ()=>{
  currentLevel = 1;
  startGame();
});
E.nameInput.addEventListener("keydown", e=>{
  if(e.key === "Enter"){
    currentLevel = 1;
    startGame();
  }
});
E.btnGiveUp.addEventListener("click", endGame);
E.btnReplay.addEventListener("click", ()=>{
  E.summary.classList.add("hidden");
  // ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏î‡∏¥‡∏°
  startGame();
});
E.btnLevel2.addEventListener("click", ()=>{
  // ‡πÑ‡∏õ‡πÄ‡∏•‡πà‡∏ô Level 2
  currentLevel = 2;
  E.summary.classList.add("hidden");
  startGame();
});
E.btnBackHome.addEventListener("click", ()=>{
  // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ intro ‡πÅ‡∏£‡∏Å
  E.summary.classList.add("hidden");
  E.game.classList.add("hidden");
  E.start.classList.add("hidden");
  E.intro.classList.remove("hidden");
});

</script>
</bo